name: Deploy Packwiz to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'servers/**/pack.toml'
      - 'servers/**/index.toml'
      - 'servers/**/mods/**'
      - 'servers/**/resourcepacks/**'
      - 'servers/**/shaderpacks/**'
      - '.github/workflows/pages.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build pages content
        run: |
          mkdir -p _site

          # Create landing page
          cat > _site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Minecraft Servers - Packwiz Modpacks</title>
            <style>
              :root {
                --bg: #1a1a2e;
                --surface: #16213e;
                --primary: #4ade80;
                --text: #e2e8f0;
                --text-muted: #94a3b8;
                --border: #334155;
              }
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: system-ui, -apple-system, sans-serif;
                background: var(--bg);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
              }
              .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 2rem 1rem;
              }
              h1 {
                color: var(--primary);
                font-size: 2rem;
                margin-bottom: 0.5rem;
              }
              .subtitle {
                color: var(--text-muted);
                margin-bottom: 2rem;
              }
              .server-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
              }
              .server-card h2 {
                color: var(--primary);
                font-size: 1.25rem;
                margin-bottom: 1rem;
              }
              .server-info {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 0.5rem 1rem;
                margin-bottom: 1rem;
              }
              .label {
                color: var(--text-muted);
                font-weight: 500;
              }
              .url-box {
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 0.75rem 1rem;
                font-family: ui-monospace, monospace;
                font-size: 0.875rem;
                word-break: break-all;
                margin-top: 0.5rem;
              }
              a {
                color: var(--primary);
                text-decoration: none;
              }
              a:hover {
                text-decoration: underline;
              }
              .setup-section {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1.5rem;
                margin-top: 2rem;
              }
              .setup-section h2 {
                color: var(--text);
                font-size: 1.25rem;
                margin-bottom: 1rem;
              }
              ol {
                padding-left: 1.5rem;
              }
              li {
                margin-bottom: 0.5rem;
              }
              code {
                background: var(--bg);
                padding: 0.125rem 0.375rem;
                border-radius: 4px;
                font-family: ui-monospace, monospace;
                font-size: 0.875rem;
              }
              .footer {
                margin-top: 2rem;
                text-align: center;
                color: var(--text-muted);
                font-size: 0.875rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Minecraft Server Modpacks</h1>
              <p class="subtitle">Packwiz modpacks for automated client syncing</p>
          HTMLEOF

          # Add each server to the landing page
          for server_dir in servers/*/; do
            server=$(basename "$server_dir")
            if [[ -f "$server_dir/pack.toml" ]]; then
              # Copy packwiz files to _site
              mkdir -p "_site/$server"
              cp "$server_dir/pack.toml" "_site/$server/"
              cp "$server_dir/index.toml" "_site/$server/"

              # Copy mods, resourcepacks, shaderpacks
              for subdir in mods resourcepacks shaderpacks; do
                if [[ -d "$server_dir/$subdir" ]]; then
                  cp -r "$server_dir/$subdir" "_site/$server/"
                fi
              done

              # Extract pack info for landing page
              pack_name=$(grep '^name = ' "$server_dir/pack.toml" | cut -d'"' -f2)
              mc_version=$(grep '^minecraft = ' "$server_dir/pack.toml" | cut -d'"' -f2)
              modloader="Unknown"
              if grep -q '^neoforge = ' "$server_dir/pack.toml"; then
                modloader="NeoForge $(grep '^neoforge = ' "$server_dir/pack.toml" | cut -d'"' -f2)"
              elif grep -q '^fabric = ' "$server_dir/pack.toml"; then
                modloader="Fabric $(grep '^fabric = ' "$server_dir/pack.toml" | cut -d'"' -f2)"
              elif grep -q '^forge = ' "$server_dir/pack.toml"; then
                modloader="Forge $(grep '^forge = ' "$server_dir/pack.toml" | cut -d'"' -f2)"
              fi
              mod_count=$(find "$server_dir/mods" -name "*.pw.toml" 2>/dev/null | wc -l)

              cat >> _site/index.html << SERVEREOF
              <div class="server-card">
                <h2>$pack_name</h2>
                <div class="server-info">
                  <span class="label">Server ID:</span>
                  <span>$server</span>
                  <span class="label">Minecraft:</span>
                  <span>$mc_version</span>
                  <span class="label">Mod Loader:</span>
                  <span>$modloader</span>
                  <span class="label">Mods:</span>
                  <span>$mod_count mods</span>
                </div>
                <span class="label">Pack URL:</span>
                <div class="url-box">https://curtbushko.github.io/minecraft-servers/$server/pack.toml</div>
                <p style="margin-top: 1rem;"><a href="./$server/pack.toml">View pack.toml â†’</a></p>
              </div>
          SERVEREOF
            fi
          done

          cat >> _site/index.html << 'HTMLEOF'
              <div class="setup-section">
                <h2>Client Setup Instructions</h2>
                <p style="margin-bottom: 1rem;">Use packwiz-installer for automatic mod syncing with your launcher:</p>
                <ol>
                  <li>Install <a href="https://prismlauncher.org/">Prism Launcher</a> or MultiMC</li>
                  <li>Create a new instance with the matching Minecraft version and mod loader</li>
                  <li>Download <a href="https://github.com/packwiz/packwiz-installer-bootstrap/releases">packwiz-installer-bootstrap.jar</a></li>
                  <li>Place it in your instance's <code>.minecraft</code> folder</li>
                  <li>Add a pre-launch command in instance settings:
                    <div class="url-box">java -jar packwiz-installer-bootstrap.jar [PACK_URL]</div>
                  </li>
                  <li>Launch the game - mods will auto-sync on every start!</li>
                </ol>
              </div>

              <div class="footer">
                <p>Powered by <a href="https://packwiz.infra.link/">packwiz</a> and <a href="https://github.com/itzg/docker-minecraft-server">itzg/docker-minecraft-server</a></p>
              </div>
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
