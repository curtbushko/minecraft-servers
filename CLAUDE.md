# Claude Code Context - Minecraft Servers Repository

This document provides context for Claude Code to effectively work in this repository.

## Repository Overview

This repository manages Docker-based Minecraft servers using **packwiz** for modpack management. Each server has its own modpack configuration, and Docker images are automatically built and published to GitHub Container Registry (ghcr.io).

## Architecture

```
minecraft-servers/
├── servers/                    # Server modpacks
│   └── <server-name>/
│       ├── pack.toml           # Packwiz config (MC version, loader, metadata)
│       ├── index.toml          # Auto-generated file index (DO NOT EDIT)
│       ├── mods/               # Mod metadata (.pw.toml files)
│       ├── resourcepacks/      # Resource pack metadata
│       ├── shaderpacks/        # Shader pack metadata
│       ├── Dockerfile          # Uses itzg/minecraft-server base
│       └── server.env          # Server-specific config
├── scripts/
│   ├── build.sh                # Build Docker images
│   ├── push.sh                 # Push to ghcr.io
│   └── packwiz-update.sh       # Update all mods in a server
├── .github/workflows/
│   ├── build-push.yml          # CI: Build and push Docker images
│   └── pages.yml               # CI: Deploy packwiz to GitHub Pages
├── flake.nix                   # Nix development environment
├── .envrc                      # direnv configuration
└── .gitattributes              # CRITICAL: Preserves .toml file hashes
```

## Key Concepts

### Packwiz Modpack Format

Packwiz is a command-line tool for creating Minecraft modpacks. Key files:

- **pack.toml**: Main config with Minecraft version, mod loader, and pack metadata
- **index.toml**: Auto-generated manifest of all files (regenerated by `packwiz refresh`)
- **mods/*.pw.toml**: Individual mod metadata files containing:
  - `name`: Display name
  - `filename`: JAR filename
  - `side`: `"both"`, `"server"`, or `"client"` (CRITICAL for filtering)
  - `[download]`: URL and hash for verification
  - `[update.modrinth]`: Modrinth project/version IDs for updates

### Server-Side vs Client-Side Filtering

The `side` field in `.pw.toml` files determines where mods run:

- `side = "both"`: Runs on both server and client (most mods)
- `side = "server"`: Server-only mods
- `side = "client"`: Client-only mods (Sodium, shaders, minimaps)

**The itzg/minecraft-server Docker image automatically filters out `side = "client"` mods.**

This means:
- The same packwiz files serve both server and client
- Clients get ALL mods (including client-only)
- Servers only get server-compatible mods

### Docker Images

Built using `itzg/minecraft-server:java21` base image with:
- `PACKWIZ_URL` environment variable pointing to GitHub Pages
- Automatic mod downloading on container start
- Built-in server-side filtering

## Common Tasks

### Adding a New Mod

```bash
cd servers/dj-server
packwiz modrinth add <mod-name>
# Or for CurseForge:
packwiz curseforge add <mod-name>
```

### Updating All Mods

```bash
./scripts/packwiz-update.sh dj-server
# Or dry run first:
./scripts/packwiz-update.sh dj-server --dry-run
```

### Building Docker Image Locally

```bash
./scripts/build.sh dj-server
# With specific tag:
./scripts/build.sh dj-server --tag v1.0.0
```

### Adding a New Server

1. Create directory: `mkdir -p servers/new-server`
2. Initialize packwiz:
   ```bash
   cd servers/new-server
   packwiz init --name "Server Name" --mc-version 1.21.1 --modloader neoforge --modloader-version 21.1.217
   ```
3. Add mods: `packwiz modrinth add sodium lithium`
4. Copy Dockerfile from existing server and update
5. Create server.env with IMAGE_NAME

### Refreshing Index After Manual Edits

If you manually edit any `.pw.toml` file:
```bash
cd servers/<server>
packwiz refresh
```
This regenerates `index.toml` with correct hashes.

## Important Files to Understand

### pack.toml Structure
```toml
name = "D&J Minecraft Server Modpack"
author = "curtbushko"
version = "1.0.0"
pack-format = "packwiz:1.1.0"

[index]
file = "index.toml"
hash-format = "sha256"
hash = "..."  # Auto-updated by packwiz refresh

[versions]
minecraft = "1.21.1"
neoforge = "21.1.217"

[options]
acceptable-game-versions = ["1.21.x"]  # Allow mods tagged 1.21.x
```

### Mod .pw.toml Structure
```toml
name = "Sodium"
filename = "sodium-neoforge-0.6.13+mc1.21.1.jar"
side = "client"  # CRITICAL: client/server/both

[download]
url = "https://cdn.modrinth.com/data/..."
hash-format = "sha512"
hash = "..."

[update]
[update.modrinth]
mod-id = "AANobbMI"
version = "Pb3OXVqC"
```

### Dockerfile Pattern
```dockerfile
FROM itzg/minecraft-server:java21

ENV TYPE=NEOFORGE
ENV VERSION=1.21.1
ENV NEOFORGE_VERSION=21.1.217
ENV EULA=TRUE

ARG PACKWIZ_URL
ENV PACKWIZ_URL=${PACKWIZ_URL}
```

## CI/CD Workflows

### build-push.yml
- Triggers on: push to `servers/`, `scripts/`, releases, manual dispatch
- Detects changed servers and builds only those
- Pushes to `ghcr.io/curtbushko/minecraft-servers/<server>:<tag>`

### pages.yml
- Triggers on: changes to packwiz files in `servers/`
- Deploys all server packwiz files to GitHub Pages
- Client URL: `https://curtbushko.github.io/minecraft-servers/<server>/pack.toml`

## Critical Warnings

1. **NEVER manually edit index.toml** - Always use `packwiz refresh`
2. **Always run `packwiz refresh` after editing any .pw.toml file**
3. **The `.gitattributes` file is CRITICAL** - It marks `.toml` files as binary to preserve hashes across platforms
4. **Check `side` field when adding mods** - Client-only mods (rendering, shaders) should be `side = "client"`

## Development Environment

Enter development shell:
```bash
nix develop
# Or with direnv:
direnv allow
```

This provides: docker, go, curl, jq, gh, java21, and installs packwiz via `go install`.

## Useful Links

- [Packwiz Documentation](https://packwiz.infra.link/)
- [itzg/docker-minecraft-server](https://docker-minecraft-server.readthedocs.io/)
- [Modrinth API](https://docs.modrinth.com/)
- [packwiz-installer](https://packwiz.infra.link/tutorials/installing/packwiz-installer/)

## Troubleshooting

### "Hash mismatch" errors
Run `packwiz refresh` to regenerate index.toml

### Mods not downloading on server
Check `side` field - must be `"both"` or `"server"`, not `"client"`

### Rate limiting from Modrinth
Increase delay: `DELAY_SECONDS=5 ./scripts/packwiz-update.sh dj-server`

### GitHub Pages not updating
Check Actions tab - pages.yml workflow must complete successfully
